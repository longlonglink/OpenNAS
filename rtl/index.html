
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="一个高性能、低功耗的开源网络附加存储（NAS）项目">
      
      
        <meta name="author" content="OpenNAS Team">
      
      
        <link rel="canonical" href="https://longlonglink.github.io/OpenNAS/docs/rtl/">
      
      
        <link rel="prev" href="../hw/">
      
      
        <link rel="next" href="../sw/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Firmware Implementation - OpenNAS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#opennas-firmware-implementation-guide" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href=".." title="OpenNAS" class="md-header__button md-logo" aria-label="OpenNAS" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OpenNAS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Firmware Implementation
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="切换至夜间模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换至夜间模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="切换至日间模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换至日间模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/longlonglink/OpenNAS" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    OpenNAS
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../introduction/" class="md-tabs__link">
          
  
  
    
  
  Project

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../documentation/" class="md-tabs__link">
        
  
  
    
  
  Documentation

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../zh/" class="md-tabs__link">
          
  
  
    
  
  中文版 / Chinese

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="OpenNAS" class="md-nav__button md-logo" aria-label="OpenNAS" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    OpenNAS
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/longlonglink/OpenNAS" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    OpenNAS
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../introduction/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Project
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Project
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hw/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hardware
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Firmware
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Firmware
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-spinalhdl" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why SpinalHDL?
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#development-environment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Development Environment
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Development Environment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toolchain" class="md-nav__link">
    <span class="md-ellipsis">
      
        Toolchain
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#environment-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Environment Setup
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tcp-offload-engine-toe-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        TCP Offload Engine (TOE) Implementation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TCP Offload Engine (TOE) Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture-design" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture Design
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture Design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#module-division" class="md-nav__link">
    <span class="md-ellipsis">
      
        Module Division
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-interface-description" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Interface Description
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-tcp-state-machine" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. TCP State Machine
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Performance Optimization
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Storage Implementation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Storage Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nvme-controller" class="md-nav__link">
    <span class="md-ellipsis">
      
        NVMe Controller
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NVMe Controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pcie-soft-core-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        PCIe Soft Core Implementation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nvme-queue-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        NVMe Queue Management
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dma-engine" class="md-nav__link">
    <span class="md-ellipsis">
      
        DMA Engine
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network-acceleration-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Network Acceleration Implementation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Network Acceleration Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#load-balancing-and-failover" class="md-nav__link">
    <span class="md-ellipsis">
      
        Load Balancing and Failover
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#energy-efficiency-optimization-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Energy Efficiency Optimization Implementation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Energy Efficiency Optimization Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fan-curve" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fan Curve
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simulation-and-verification" class="md-nav__link">
    <span class="md-ellipsis">
      
        Simulation and Verification
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Simulation and Verification">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#verification-methods" class="md-nav__link">
    <span class="md-ellipsis">
      
        Verification Methods
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        Simulation Tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging-tips" class="md-nav__link">
    <span class="md-ellipsis">
      
        Debugging Tips
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#development-guidelines" class="md-nav__link">
    <span class="md-ellipsis">
      
        Development Guidelines
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Development Guidelines">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spinalhdl-code-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        SpinalHDL Code Example
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mixed-design" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mixed Design
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      
        References
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#contributing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Contributing
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sw/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Software
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../documentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Documentation
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../zh/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    中文版 / Chinese
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    中文版 / Chinese
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../zh/introduction/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    项目
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    项目
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/hw/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    硬件
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/rtl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    固件
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/sw/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    软件
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zh/documentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    文档
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-spinalhdl" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why SpinalHDL?
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#development-environment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Development Environment
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Development Environment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#toolchain" class="md-nav__link">
    <span class="md-ellipsis">
      
        Toolchain
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#environment-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Environment Setup
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tcp-offload-engine-toe-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        TCP Offload Engine (TOE) Implementation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TCP Offload Engine (TOE) Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture-design" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture Design
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture Design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#module-division" class="md-nav__link">
    <span class="md-ellipsis">
      
        Module Division
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-interface-description" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Interface Description
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-tcp-state-machine" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. TCP State Machine
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Performance Optimization
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Storage Implementation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Storage Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nvme-controller" class="md-nav__link">
    <span class="md-ellipsis">
      
        NVMe Controller
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NVMe Controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pcie-soft-core-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        PCIe Soft Core Implementation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nvme-queue-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        NVMe Queue Management
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dma-engine" class="md-nav__link">
    <span class="md-ellipsis">
      
        DMA Engine
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network-acceleration-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Network Acceleration Implementation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Network Acceleration Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#load-balancing-and-failover" class="md-nav__link">
    <span class="md-ellipsis">
      
        Load Balancing and Failover
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#energy-efficiency-optimization-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Energy Efficiency Optimization Implementation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Energy Efficiency Optimization Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fan-curve" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fan Curve
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simulation-and-verification" class="md-nav__link">
    <span class="md-ellipsis">
      
        Simulation and Verification
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Simulation and Verification">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#verification-methods" class="md-nav__link">
    <span class="md-ellipsis">
      
        Verification Methods
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        Simulation Tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging-tips" class="md-nav__link">
    <span class="md-ellipsis">
      
        Debugging Tips
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#development-guidelines" class="md-nav__link">
    <span class="md-ellipsis">
      
        Development Guidelines
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Development Guidelines">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spinalhdl-code-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        SpinalHDL Code Example
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mixed-design" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mixed Design
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      
        References
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#contributing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Contributing
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/longlonglink/OpenNAS/edit/main/docs/rtl/index.md" title="编辑此页" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="opennas-firmware-implementation-guide">OpenNAS Firmware Implementation Guide<a class="headerlink" href="#opennas-firmware-implementation-guide" title="Permanent link">&para;</a></h1>
<p>This document provides detailed information on implementing the FPGA firmware for the OpenNAS project, including core features such as TCP Offload Engine (TOE), storage implementation, network acceleration, and energy efficiency optimization.</p>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>OpenNAS firmware is implemented on Xilinx Zynq-7000 series FPGA (XC7Z035) using <strong>Scala with SpinalHDL mixed with Verilog</strong> to write HDL code. This hybrid design approach combines SpinalHDL's type safety and high-level abstraction capabilities with Verilog's flexibility and compatibility, making the code more robust and maintainable. The firmware design follows modular and extensible principles, with all code fully open source.</p>
<h3 id="why-spinalhdl">Why SpinalHDL?<a class="headerlink" href="#why-spinalhdl" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Type Safety</strong>: Scala's strong type system can catch many errors at compile time</li>
<li><strong>High-Level Abstraction</strong>: SpinalHDL provides higher-level hardware description abstractions, reducing code volume</li>
<li><strong>Reusability</strong>: Better modularity and code reuse</li>
<li><strong>Mixed Design</strong>: Seamless integration with existing Verilog IP cores</li>
</ul>
<h2 id="development-environment">Development Environment<a class="headerlink" href="#development-environment" title="Permanent link">&para;</a></h2>
<h3 id="toolchain">Toolchain<a class="headerlink" href="#toolchain" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Primary Tool</strong>: Xilinx Vivado (current version)</li>
<li><strong>Future Plans</strong>: Support for open-source toolchains (Yosys + nextpnr)</li>
<li><strong>Simulation Tools</strong>: XSim (Vivado built-in), Verilator (open-source simulator)</li>
<li><strong>Version Control</strong>: Git</li>
<li><strong>Build Tool</strong>: SBT (Scala Build Tool)</li>
</ul>
<h3 id="environment-setup">Environment Setup<a class="headerlink" href="#environment-setup" title="Permanent link">&para;</a></h3>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><span class="c1"># Install Scala and SBT</span>
</span><span id="__span-0-2"><span class="c1"># Install Vivado</span>
</span><span id="__span-0-3"><span class="c1"># Configure environment variables</span>
</span><span id="__span-0-4"><span class="nb">export</span><span class="w"> </span><span class="nv">VIVADO_HOME</span><span class="o">=</span>/path/to/vivado
</span><span id="__span-0-5"><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$VIVADO_HOME</span>/bin
</span></code></pre></div></td></tr></table></div>
<h2 id="tcp-offload-engine-toe-implementation">TCP Offload Engine (TOE) Implementation<a class="headerlink" href="#tcp-offload-engine-toe-implementation" title="Permanent link">&para;</a></h2>
<h3 id="architecture-design">Architecture Design<a class="headerlink" href="#architecture-design" title="Permanent link">&para;</a></h3>
<p>The TOE module offloads the TCP/IP protocol stack from CPU to FPGA hardware, achieving high-performance network processing. The module adopts a pipeline design, supporting 10Gbps line-rate processing.</p>
<h4 id="module-division">Module Division<a class="headerlink" href="#module-division" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>MAC Layer Interface</strong></li>
<li>10Gbps Ethernet MAC interface</li>
<li>Supports SFP+ optical modules</li>
<li>Auto-negotiation and link management</li>
<li>
<p>Supports 4 independent network interfaces</p>
</li>
<li>
<p><strong>IP Layer Processing</strong></p>
</li>
<li>IPv4/IPv6 packet parsing</li>
<li>IP routing and forwarding</li>
<li>Fragmentation and reassembly</li>
<li>
<p>Supports multicast and broadcast</p>
</li>
<li>
<p><strong>TCP Layer Processing</strong></p>
</li>
<li>Connection establishment and teardown (three-way handshake, four-way handshake)</li>
<li>Sequence number and acknowledgment number management</li>
<li>Flow control and congestion control</li>
<li>Retransmission mechanism</li>
<li>
<p>Supports large numbers of concurrent connections (up to 64K)</p>
</li>
<li>
<p><strong>Application Layer Interface</strong></p>
</li>
<li>AXI4 interface with ARM CPU: For control plane communication and configuration</li>
<li>AXI-Stream interface with NVMe module: For data plane zero-copy transfer</li>
<li>Zero-copy data transfer: Data transfers directly between network and storage, bypassing CPU</li>
<li>Event notification mechanism: Notifies CPU through interrupts or polling</li>
</ol>
<h3 id="implementation-details">Implementation Details<a class="headerlink" href="#implementation-details" title="Permanent link">&para;</a></h3>
<h4 id="1-interface-description">1. Interface Description<a class="headerlink" href="#1-interface-description" title="Permanent link">&para;</a></h4>
<p>The TOE module provides the following main interfaces:</p>
<p><strong>AXI4 Interface with ARM CPU</strong>:
- <strong>AXI4-Lite Control Interface</strong>: For configuring TOE parameters, querying connection status, etc.
- <strong>AXI4 Data Interface</strong>: For transferring small amounts of control data
- <strong>Interrupt Interface</strong>: For event notification (e.g., new connection established, connection closed, etc.)</p>
<p><strong>AXI-Stream Interface with NVMe Module</strong>:
- <strong>Receive Data Stream (RX)</strong>: Data received from network directly transferred to NVMe module via AXI-Stream
- <strong>Transmit Data Stream (TX)</strong>: Data read from NVMe module directly transferred to network via AXI-Stream
- <strong>Flow Control Signals</strong>: Standard AXI-Stream signals such as <code>tready</code>, <code>tvalid</code>, <code>tlast</code>
- <strong>Data Width</strong>: 512-bit, matching NVMe data width</p>
<p><strong>Network Interface</strong>:
- <strong>4× 10Gbps SFP+ Interfaces</strong>: Supports optical modules and direct-attach copper cables
- <strong>MAC Layer Interface</strong>: Interface with Ethernet PHY</p>
<p><strong>Internal Interfaces</strong>:
- <strong>Connection Table Interface</strong>: For lookup and management of TCP connections
- <strong>Buffer Interface</strong>: For temporary storage of packets</p>
<h4 id="2-tcp-state-machine">2. TCP State Machine<a class="headerlink" href="#2-tcp-state-machine" title="Permanent link">&para;</a></h4>
<h3 id="performance-optimization">Performance Optimization<a class="headerlink" href="#performance-optimization" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Pipeline Design</strong>: Divide packet processing into multiple pipeline stages to improve throughput</li>
<li><strong>Parallel Processing</strong>: Support multiple packets processing simultaneously, fully utilizing FPGA parallelism</li>
<li><strong>Zero-Copy</strong>: Data transfers directly between FPGA and memory, bypassing CPU, reducing latency</li>
<li><strong>Hardware Acceleration</strong>: TCP checksum, IP checksum calculated in hardware</li>
</ol>
<h2 id="storage-implementation">Storage Implementation<a class="headerlink" href="#storage-implementation" title="Permanent link">&para;</a></h2>
<h3 id="nvme-controller">NVMe Controller<a class="headerlink" href="#nvme-controller" title="Permanent link">&para;</a></h3>
<h4 id="pcie-soft-core-implementation">PCIe Soft Core Implementation<a class="headerlink" href="#pcie-soft-core-implementation" title="Permanent link">&para;</a></h4>
<p>The PCIe soft core uses Xilinx GT (Gigabit Transceiver) to implement PCIe 3.0 x4 interface. This implementation includes:</p>
<ul>
<li><strong>PCIe Configuration Space</strong>: Implements standard PCIe configuration registers</li>
<li><strong>TLP (Transaction Layer Packet) Processing</strong>: Handles PCIe transaction layer packets</li>
<li><strong>Link Training</strong>: Auto-negotiates link speed and width</li>
<li><strong>Error Handling</strong>: CRC checking, retransmission mechanisms, etc.</li>
</ul>
<p>The PCIe soft core connects with the NVMe controller through AXI4 interface, achieving efficient data transfer.</p>
<h4 id="nvme-queue-management">NVMe Queue Management<a class="headerlink" href="#nvme-queue-management" title="Permanent link">&para;</a></h4>
<p><strong>Multi-Queue Concurrency</strong> is one of the core features of NVMe. OpenNAS implements complete NVMe multi-queue support:</p>
<p><strong>Queue Architecture</strong>:
- <strong>Admin Queue</strong>: 1 submission queue (SQ) and 1 completion queue (CQ)
- <strong>I/O Queues</strong>: Supports up to 65535 I/O queue pairs (each queue pair contains 1 SQ and 1 CQ)
- <strong>Queue Depth</strong>: Each queue supports up to 65536 entries</p>
<p><strong>Concurrent Processing</strong>:
- <strong>Parallel Queue Processing</strong>: Multiple I/O queues can process commands simultaneously
- <strong>Queue Priority</strong>: Supports queue priority scheduling
- <strong>Interrupt Aggregation</strong>: Interrupts from multiple completion queues can be aggregated, reducing CPU interrupt overhead</p>
<p><strong>Implementation Features</strong>:
- Uses SpinalHDL to implement type-safe queue management
- Hardware-implemented queue pointer management, avoiding software overhead
- Supports MSI/MSI-X interrupt mechanisms
- Directly connects with TOE module through AXI-Stream interface, achieving zero-copy</p>
<h3 id="dma-engine">DMA Engine<a class="headerlink" href="#dma-engine" title="Permanent link">&para;</a></h3>
<p><strong>SGDMA (Scatter-Gather DMA)</strong> engine implements efficient data transfer:</p>
<p><strong>Features</strong>:
- <strong>Scatter/Gather Transfer</strong>: Supports transfer of non-contiguous memory regions
- <strong>Automatic Page Boundary Handling</strong>: Automatically handles transfers across page boundaries
- <strong>Multi-Channel Support</strong>: Supports multiple independent DMA channels
- <strong>Priority Scheduling</strong>: Supports channel priority scheduling</p>
<p><strong>Integration with NVMe</strong>:
- DMA engine directly connects with NVMe controller
- Supports NVMe's PRP (Physical Region Page) and SGL (Scatter-Gather List) descriptors
- Automatically handles data transfer for NVMe commands</p>
<p><strong>Performance Optimization</strong>:
- Uses AXI4 burst transfer to improve bandwidth utilization
- Supports prefetch mechanism to reduce latency
- Hardware-implemented descriptor list traversal, reducing CPU load</p>
<h2 id="network-acceleration-implementation">Network Acceleration Implementation<a class="headerlink" href="#network-acceleration-implementation" title="Permanent link">&para;</a></h2>
<h3 id="load-balancing-and-failover">Load Balancing and Failover<a class="headerlink" href="#load-balancing-and-failover" title="Permanent link">&para;</a></h3>
<p>OpenNAS provides <strong>4× 10Gbps network interfaces</strong>, supporting multiple aggregation modes:</p>
<p><strong>Load Balancing Modes</strong>:
- <strong>Round-Robin</strong>: Distributes traffic to each interface in sequence
- <strong>Least Connections</strong>: Assigns new connections to the interface with the fewest connections
- <strong>Hash</strong>: Hashes based on source/destination IP and port, ensuring the same connection uses the same interface
- <strong>Weighted Round-Robin</strong>: Distributes traffic based on interface weights</p>
<p><strong>Failover Modes</strong>:
- <strong>Active-Standby</strong>: One primary interface works, others serve as backup
- <strong>Link Aggregation</strong>: Multiple interfaces aggregated into one logical interface, improving bandwidth and reliability</p>
<p><strong>Application Scenarios</strong>:
- <strong>Dual-Port NIC Direct Connection</strong>: Two devices connected via dual-port direct connection, achieving high bandwidth and redundancy
- <strong>Multi-Path Transfer</strong>: Utilizes multiple network paths to increase total bandwidth
- <strong>Network Redundancy</strong>: Automatically switches to other interfaces when one interface fails</p>
<p><strong>Implementation Details</strong>:
- Hardware-implemented load balancing algorithms, low latency
- Real-time interface status monitoring, fast fault detection
- Supports LACP (Link Aggregation Control Protocol)
- Integrated with TOE module, achieving transparent load balancing</p>
<h2 id="energy-efficiency-optimization-implementation">Energy Efficiency Optimization Implementation<a class="headerlink" href="#energy-efficiency-optimization-implementation" title="Permanent link">&para;</a></h2>
<h3 id="fan-curve">Fan Curve<a class="headerlink" href="#fan-curve" title="Permanent link">&para;</a></h3>
<p>OpenNAS uses <strong>XADC (Xilinx Analog-to-Digital Converter)</strong> to read temperature and controls fan speed according to configured fan curve.</p>
<p><strong>XADC Interface</strong>:
- <strong>Temperature Sensor</strong>: Reads FPGA internal temperature sensor
- <strong>External Temperature Sensors</strong>: Supports connecting external temperature sensors (e.g., CPU, NVMe SSD, etc.)
- <strong>12-bit ADC</strong>: High-precision temperature measurement
- <strong>Sampling Frequency</strong>: Configurable sampling frequency</p>
<p><strong>Fan Curve Configuration</strong>:
- <strong>Multi-Segment Linear Curve</strong>: Supports configuring multi-segment linear fan curves
- <strong>Temperature Thresholds</strong>: Configurable multiple temperature threshold points
- <strong>Speed Range</strong>: Supports PWM control, speed range 0-100%
- <strong>Smooth Control</strong>: Uses PID controller to achieve smooth fan speed adjustment</p>
<p><strong>Typical Fan Curve</strong>:
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1">Temperature &lt; 40°C:  Fan speed 20%
</span><span id="__span-1-2">40°C - 50°C: Fan speed 20% - 40% (linear)
</span><span id="__span-1-3">50°C - 60°C: Fan speed 40% - 60% (linear)
</span><span id="__span-1-4">60°C - 70°C: Fan speed 60% - 80% (linear)
</span><span id="__span-1-5">Temperature &gt; 70°C:  Fan speed 100%
</span></code></pre></div></td></tr></table></div></p>
<p><strong>Implementation Method</strong>:
- Uses SpinalHDL to implement temperature monitoring module
- Hardware-implemented PID controller, fast response
- Supports configuring fan curve parameters through AXI4-Lite interface
- Real-time temperature monitoring and fan control, no CPU intervention required</p>
<p><strong>Safety Features</strong>:
- <strong>Over-Temperature Protection</strong>: Automatically increases fan speed or reduces operating frequency when temperature exceeds safety threshold
- <strong>Fault Detection</strong>: Detects fan faults (e.g., stopped) and alarms
- <strong>Temperature History</strong>: Records temperature history data for analysis and optimization</p>
<h2 id="simulation-and-verification">Simulation and Verification<a class="headerlink" href="#simulation-and-verification" title="Permanent link">&para;</a></h2>
<h3 id="verification-methods">Verification Methods<a class="headerlink" href="#verification-methods" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Unit Testing</strong>: Each module tested independently using SpinalHDL's testing framework</li>
<li><strong>Integration Testing</strong>: Interface testing between modules, verifying data flow correctness</li>
<li><strong>System Testing</strong>: Complete functionality testing, including end-to-end data transfer</li>
<li><strong>Performance Testing</strong>: Throughput and latency testing, verifying design goals are met</li>
</ol>
<h3 id="simulation-tools">Simulation Tools<a class="headerlink" href="#simulation-tools" title="Permanent link">&para;</a></h3>
<p><strong>XSim (Vivado Simulator)</strong>:
- Built-in Vivado simulator
- Supports Verilog, VHDL, SystemVerilog
- Seamless integration with Vivado toolchain</p>
<p><strong>Verilator</strong>:
- Open-source Verilog simulator
- High performance, suitable for large-scale simulation
- Supports SystemVerilog subset</p>
<h3 id="debugging-tips">Debugging Tips<a class="headerlink" href="#debugging-tips" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>ILA (Integrated Logic Analyzer)</strong>: Use Vivado ILA for online debugging, viewing signal waveforms in real-time</li>
<li><strong>Simulation Waveforms</strong>: Use XSim or Verilator to view detailed waveforms, analyze timing issues</li>
<li><strong>Log Output</strong>: Use <code>println</code> in SpinalHDL code to output debug information</li>
<li><strong>Assertions</strong>: Use SystemVerilog assertions to check design constraints</li>
</ol>
<h2 id="development-guidelines">Development Guidelines<a class="headerlink" href="#development-guidelines" title="Permanent link">&para;</a></h2>
<h3 id="spinalhdl-code-example">SpinalHDL Code Example<a class="headerlink" href="#spinalhdl-code-example" title="Permanent link">&para;</a></h3>
<h3 id="mixed-design">Mixed Design<a class="headerlink" href="#mixed-design" title="Permanent link">&para;</a></h3>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://www.xilinx.com/products/silicon-devices/soc/zynq-7000.html">Xilinx Zynq-7000 Technical Documentation</a></li>
<li><a href="https://spinalhdl.github.io/SpinalDoc-RTD/">SpinalHDL Official Documentation</a></li>
<li><a href="https://pcisig.com/">PCIe Specification</a></li>
<li><a href="https://nvmexpress.org/">NVMe Specification</a></li>
<li><a href="https://tools.ietf.org/html/rfc793">TCP/IP Protocol Details</a></li>
<li><a href="https://developer.arm.com/documentation/ihi0022/latest/">AXI4 Specification</a></li>
</ul>
<h2 id="contributing">Contributing<a class="headerlink" href="#contributing" title="Permanent link">&para;</a></h2>
<p>Contributions are welcome! Please follow these steps:</p>
<ol>
<li>Fork the project</li>
<li>Create a feature branch</li>
<li>Write code and tests (using SpinalHDL or Verilog)</li>
<li>Ensure all tests pass</li>
<li>Submit a Pull Request</li>
</ol>
<p>For more information, please refer to the project's contribution guidelines.</p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      OpenNAS Team
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/longlonglink" target="_blank" rel="noopener" title="GitHub | longlonglink" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.tabs", "navigation.top", "navigation.indexes", "navigation.expand", "search.suggest", "search.highlight", "content.code.copy", "content.action.edit"], "search": "../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>